## 1. ネットワーク作成
1. VPC作成
    - IPv4 CIDRブロック: 10.0.0.0/16

2. サブネットを作成
    - AZ-a: パブリック(10.0.10.0/24), プライベート(10.0.11.0/24)
    - AZ-c: パブリック(10.0.20.0/24), プライベート(10.0.21.0/24)

3. インターネットゲートウェイの設定
    - インターネットゲートウェイを作成
    - VPCへアタッチ

4. ルートテーブルを作成
    - プライベートサブネットを全て追加
    - デフォルトルート(0.0.0.0/0)をインターネットゲートウェイへ変更

5. セキュリティグループ作成
    - EC2(80, 22)
    - RDS(3306)
    - ALB


* `ルートテーブル`: ルーターに記録される経路情報
* `インターネットゲートウェイ`: VPCとインターネットを接続
* `セキュリティグループ`: デフォルトではどこからでもSSH可能 -> 自宅やオフィスのIPに指定するべき
* デフォルトだとターゲットはlocal(自身)のみなので、インターネットゲートウェイに向ける必要(publicのみ)
* プライベートIPアドレスの範囲で指定
* 作成後は変更できないので、/28 or /16
-----------------------------------------------------------------------

## 2. EC2作成
1. AMIの選択
2. インスタンスの設定
    - ネットワーク
    - サブネット
    - 自動割り当てパブリックIPを設定
    - キャパシティの予約
    - ネットワークインターフェイス(10.0.10.10)
3. タグの追加
4. セキュリティグループの設定
5. SSHキーペアを取得

* `AMI(Amazon Machine Image)`: OSのイメージ
* `インスタンスタイプ`: EC2のスペックを定義したもの
* `ストレージ(EBS, インスタンスストア)`: サーバーにくっつけるデータの保存場所
* `キーペア`: インスタンスにログインするための鍵

## EC2にSSH接続
```sh:
$ mv ~/Downloads/[秘密鍵名].pem ~/.ssh
$ chmod 600 ~/.ssh/[秘密鍵名].pem
$ ssh -i ~/.ssh/[秘密鍵名].pem ec2-user@[パブリックIP]

# sshコマンドの簡略化
$ vim ~/.ssh/config

Host [コマンドに使用する名称]
    HostName [パブリックIP]
    User ec2-user
    Port 22
    IdentityFile ~/.ssh/[秘密鍵名].pem
```
* `pemファイル`: 秘密鍵

## Apacheをインストール
```sh:
$ sudo yum update -y
$ sudo yum -y install httpd
# Apache
$ sudo systemctl start httpd.service # 起動
$ sudo systemctl status httpd.service # 確認
```

## ファイアウォールを設定
1. http, 任意の場所
2. sshも追加

* ポートを制限
* インバウンド
* アウトバウンド

## Elastic IPでIPを固定
* EC2に関連付けしていない場合は課金される
1. Elastic IPを取得
2. パブリックIPに関連付け
-----------------------------------------------------------------------


## Route53
* DNS(Domain Name System): ドメイン名をIPアドレスに変換するサーバー
* ネームサーバー: ドメイン名と紐づくIPアドレスが登録されているサーバー
* NSレコード: ドメインを管理するネームサーバーとの紐付け
* SOAレコード: ドメインのゾーンの管理情報

1. ドメインのゾーン(ネームサーバー)をRoute53に変更
    - Route53でホストゾーンを作成
    - freenom側でゾーン(ネームサーバー)をRoute53に変更
```sh:
$ dig aws-app.ml NS +short # 確認
```
2. ドメインにIPアドレスを紐付け
    - Aレコードの作成
    - IP記入
-----------------------------------------------------------------------

## RDS
- 高い可用性(master, slave)
- リードレプリカ(読み書き用, 読み取り専用)
* `スナップショット`: 自動バックアップ
* `リストア`: スナップショットを元にDBインスタンスを作成
### 準備
1. セキュリティグループの作成(EC2)
2. サブネットグループ(RDSを起動させるサブネットを制御(複数推奨))
3. パラメータグループ(DB設定値を制御)
4. オプショングループ(RDSへの機能追加を制御)
### RDS作成
1. DBエンジン
2. 本番環境
3. DB詳細の設定
4. [詳細設定]の設定
-----------------------------------------------------------------------

<!-- ## WordPressをインストール
- extrasライブラリ
- 先に7.4をインストールしておくと、php7.4に関連したphpライブラリをインストールしてくれる
```sh:
# Install php7.4
$ sudo amazon-linux-extras install -y php7.4
$ sudo yum install -y php phpmbstring
# Install wordpress
$ wget https://ja.wordpress.org/latest-ja.tar.gz
$ tar xzvf latest-ja.tar.gz
$ sudo cp -r wordpress/* /var/www/html
# ファイルの所有者をapacheに変更
$ sudo chown apache:apache /var/www/html/ -R
$ sudo systemctl restart httpd.service
-----------------------------------------------------------------------
``` -->


## ELB
1. AMIからEC2を作成(既存のEC2のコピーが作成できる)
    - パブリックサブネットの作成
    - AMIの作成
    - AMIからEC2を作成
    - 作成したEC2でApache起動
2. ELBを作成
    - AZをパブリックに指定
    - セキュリティグループ作成(HTTPを全て許可)
    - ターゲットに登録
3. 独自ドメインからELBにアクセス
    - Route53の取得したドメイン側で設定
    - トラフィックのルーティング先

* `リージョン/AZ`: 物理的
* `VPC/サブネット`: 論理的
* `VPC`: プライベートIPアドレスの範囲から切り出したアドレス空間(最大/16のアドレス空間)
* `サブネット`: 作成する際にAZを指定する必要がある
* `AZ(a,c,d)`: リージョンを分割した区分
* AZごとにサブネットを１つだけ指定できる
* ドメインと紐づけるのはパブリックIP？ElasticIP？
* Aレコードとは？
-----------------------------------------------------------------------
